@page "/"
@using System

<h3 class="text-center">Carbonacci, the spunded beer carbonation calculator</h3>

<EditForm Model="@parameters" OnValidSubmit="CalculateCarbonation">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group text-center">
        <label for="beerType">Select fermentation type:</label>
        <InputSelect @bind-Value="parameters.BeerType" id="beerType" class="form-control" @onchange="OnBeerTypeChanged">
            <option value="Uncarbonated">Uncarbonated (Force carbonation chart)</option>
            <option value="PressureFermented">Pressure Fermented (Henry's law)</option>
        </InputSelect>
    </div>

    <div class="form-group text-center">
        <label for="volume">Liquid Volume (L):</label>
        <InputNumber @bind-Value="parameters.Volume" id="volume" class="form-control" />
    </div>

    <div class="form-group text-center">
        <label for="temperature">Max Fermentation Temperature (°C):</label>
        <InputNumber @bind-Value="parameters.Temperature" id="temperature" class="form-control" />
    </div>

    <div class="form-group text-center">
        <label for="desiredCarbonation">Desired Carbonation Vol (0.0-4.0):</label>
        <InputNumber @bind-Value="parameters.DesiredCarbonation" id="desiredCarbonation" class="form-control" />
    </div>

    @if (parameters.BeerType == "PressureFermented")
    {
        <div class="form-group text-center">
            <label for="fermentationPressure">Spunding Pressure (bar):</label>
            <InputNumber @bind-Value="parameters.FermentationPressure" id="fermentationPressure" class="form-control" />
        </div>
    }

    <button type="submit" class="btn btn-primary d-block mx-auto">Calculate</button>
</EditForm>

@if (calculationResult != null)
{
    <div class="text-center">
        <h4>Results</h4>
        <p><strong>Existing CO2 weight in the beer:</strong> @calculationResult.ExistingCO2g gram</p>
        @*<p><strong>Existing volumes of CO2 in the beer:</strong> @calculationResult.Pressure bar</p>*@
        <p><strong>Needed CO2 weight for desired carbonation:</strong> @calculationResult.MissingCO2g gram</p>
        @*<p><strong>Pressure to reach equilibrium at desired carbonation volume:</strong> @calculationResult.Pressure bar</p>*@
    </div>
}

@code {
    private CarbonationParameters parameters = new CarbonationParameters();
    private CarbonationResult calculationResult;

    private void OnBeerTypeChanged(ChangeEventArgs e)
    {
        // Tilbakestill fermenteringstrykk hvis type endres
        parameters.FermentationPressure = 0;
    }

    private void CalculateCarbonation()
    {
        if (parameters.BeerType == "Uncarbonated")
        {
            calculationResult = CarbonationCalculator.CalculateStandardCarbonation(parameters);
        }
        else if (parameters.BeerType == "PressureFermented")
        {
            calculationResult = CarbonationCalculator.CalculatePressureFermentation(parameters);
        }
    }

    public class CarbonationParameters
    {
        public string BeerType { get; set; }
        public double Volume { get; set; }
        public double Temperature { get; set; }
        public double DesiredCarbonation { get; set; }
        public double FermentationPressure { get; set; }
    }

    public class CarbonationResult
    {
        public double ExistingCO2g { get; set; }  // Eksisterende CO2 i gram
        public double MissingCO2g { get; set; }   // Manglende CO2 for ønsket karbonering i gram
        public double Pressure { get; set; }      // Trykk som må påføres
        public double CarbonationTime { get; set; } // Tid for karbonering i dager
    }

    public static class CarbonationCalculator
    {
        private const double k0H = 3.3e-2;               // Henrys konstant ved 298.15 K i mol/(L·bar)
        private const double TempDependence = -2200;     // Temperaturavhengighet (K)
        private const double MolarMassCO2 = 44.01;       // g/mol
        private const double MolarVolumeSTP = 22.4;      // L/mol

        // Beregning for standard force-carbonation (ukarbonsert øl)
        public static CarbonationResult CalculateStandardCarbonation(CarbonationParameters parameters)
        {
            var carbonationTable = new Dictionary<int, double>
            {
                { 10, 2.0 },
                { 12, 2.2 },
                { 15, 2.5 },
                { 18, 2.8 },
                { 20, 3.0 }
            };

            double pressure = carbonationTable.ContainsKey((int)parameters.Temperature)
                ? carbonationTable[(int)parameters.Temperature]
                : 2.5;  // Default value

            double carbonationTime = 7; // Standard tid for force-carbonation

            return new CarbonationResult
            {
                Pressure = pressure,
                CarbonationTime = carbonationTime
            };
        }

        // Beregning for trykkfermentert øl basert på Henrys lov
        public static CarbonationResult CalculatePressureFermentation(CarbonationParameters parameters)
        {
            double kH = CalculateHenryConstant(k0H, TempDependence, parameters.Temperature);

            // Beregn eksisterende CO2 i ølet (mol)
            double existingMolPerL = kH * parameters.FermentationPressure;
            double existingMolTotal = existingMolPerL * parameters.Volume;
            double existingCO2g = existingMolTotal * MolarMassCO2;

            // Ønsket mengde CO2 i gram basert på volum (vol CO2 / vol øl)
            double desiredCO2g = CO2VolumeConverter.ConvertVolumesToCO2Mass(parameters.DesiredCarbonation, parameters.Volume);

            // Manglende CO2 for ønsket karbonering
            double missingCO2g = desiredCO2g - existingCO2g;
            if (missingCO2g < 0) missingCO2g = 0;

            // Beregn trykket som kreves for å oppnå ønsket CO2-mengde
            double requiredPressure = CalculateEquilibriumPressure(desiredCO2g, parameters.Volume, parameters.Temperature, k0H, TempDependence);

            double carbonationTime = 7; // Placeholder

            return new CarbonationResult
            {
                ExistingCO2g = existingCO2g,
                MissingCO2g = missingCO2g,
                Pressure = requiredPressure,
                CarbonationTime = carbonationTime
            };
        }

        public static double CalculateHenryConstant(double k0H, double temperatureDependence, double temperatureCelsius)
        {
            double temperatureK = temperatureCelsius + 273.15;
            double T0 = 298.15;
            return k0H * Math.Exp(temperatureDependence * (1.0 / temperatureK - 1.0 / T0));
        }

        public static double CalculateEquilibriumPressure(double desiredCO2Mass, double volume, double temperatureCelsius, double k0H, double temperatureDependence)
        {
            double molCO2 = desiredCO2Mass / MolarMassCO2;
            double concentration = molCO2 / volume;
            double kH = CalculateHenryConstant(k0H, temperatureDependence, temperatureCelsius);
            return concentration / kH;
        }

        public class CO2VolumeConverter
        {
            /// <summary>
            /// Konverterer ønsket CO₂-volum (i volumes) til gram CO₂ for gitt væskevolum.
            /// </summary>
            public static double ConvertVolumesToCO2Mass(double desiredVolumes, double beerVolumeLiters)
            {
                double totalCO2Liters = desiredVolumes * beerVolumeLiters;
                double molCO2 = totalCO2Liters / MolarVolumeSTP;
                double gramsCO2 = molCO2 * MolarMassCO2;
                return gramsCO2;
            }
        }
    }
}
